const mvc = require( "./index.js" );

mvc.get( "/temp", (req, res) => {

	mysqlHandler.getConnection()
	.then( function( connection ){

		mysqlHandler.executeQuery( "getMySqlVersion", connection )
		.then( function( queryResults ){

			var connHandler = new connectionHandler( req, res );
			connHandler.setSession( "LANG", "KOREAN" );

			logger.debug( queryResults.results );
			res.send( "Hello World" );
		} )
		.catch( function(err){
			res.send( "ERROR : " +  err )
		} ); 		
	} )
	.catch( function(err){
		res.send( "ERROR : " +  err )
	} );
} );

mvc.get( "/lang", (req, res) => {
	var connHandler = new connectionHandler( req, res );
	connHandler.getSession( "LANG", function( lang, err ){
		if( err ) throw err;

		res.send( lang );
	} );
} );






mvc.post( "/posttest", (req, res) => {
	var queryString = `update connectionInfo set userId = ? where param
	 like ? and text like ?`;

	queryString = queryString.toUpperCase();

	var queryArray = queryString.split("WHERE");
	var prePhase = queryArray[0];
	var wherePhase = ( ( queryArray[1] ).trim() ).replace( /\s\s+/g, ' ' );

	if( wherePhase.length > 0 ){
		var wherePhaseArray = wherePhase.split(" ");

		logger.debug( wherePhaseArray );

		for( var i=1; i<wherePhaseArray.length; i++ ){
			if( wherePhaseArray[i-1] === "LIKE" ){
				var param = wherePhaseArray[i];
				param = param.replace( /'/gi, "" );
				param = "'%" + param + "%'";
				wherePhaseArray[i] = param;
			}
		}

		logger.debug( wherePhaseArray );

		wherePhase = "";

		for( var i=0; i<wherePhaseArray.length; i++ ){
			wherePhase += " " + wherePhaseArray[i];
		}
	}

	queryString = prePhase + wherePhase;

	res.send( "<h1>TRUST ME</h1>" + "<p>" + queryString + "</p>" );

} );

mvc.post( "/destroysession", (req,res) => {
	var connHandler = new connectionHandler();
	connHandler.setSessionExpire( "2019-01-01", function(){
		// res.send( "SESSION DESTROYED IN HERE" );		
			res.send( "SESSION DESTROYED IN HERE" );		

	} )

} );